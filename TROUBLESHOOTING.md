# Troubleshooting Guide

This guide collects the most common troubleshooting questions raised by OnDemand Loop users and maps them to quick triage steps.
Each section focuses on a specific scenario, summarizing what the user is trying to do, how to unblock them, and when to escalate the issue to the Loop team.

## Index

- [Projects](#projects)
  - [Project was deleted accidentally](#project-was-deleted-accidentally)
  - [Rename a project](#rename-a-project)
  - [Update the project workspace to a shared folder](#update-the-project-workspace-to-a-shared-folder)
  - [Changing the project folder fails](#changing-the-project-folder-fails)
  - [Beta regression requiring a factory reset](#beta-regression-requiring-a-factory-reset)
- [Downloads](#downloads)
  - [Files are greyed out and cannot be downloaded](#files-are-greyed-out-and-cannot-be-downloaded)
  - [Where are my downloaded files?](#where-are-my-downloaded-files)
  - [How can I copy or move my downloaded files into my shared folder?](#how-can-i-copy-or-move-my-downloaded-files-into-my-shared-folder)
  - [Download is stuck in the Downloading state](#download-is-stuck-in-the-downloading-state)
  - [Download shows an error status](#download-shows-an-error-status)
  - [Downloads fail because storage is full](#new-downloads-fail-because-storage-is-full)
  - [What happens if I download the same file twice?](#what-happens-if-i-download-the-same-file-twice)
  - [Restarting a cancelled or failed download](#restarting-a-cancelled-or-failed-download)
- [Uploads](#uploads)
  - [Upload shows an error status](#upload-shows-an-error-status)
  - [Uploading large files is blocked](#uploading-large-files-is-blocked)
  - [How do I navigate to the remote repository where my files are uploaded?](#how-do-i-navigate-to-the-remote-repository-where-my-files-are-uploaded)
  - [Restarting a cancelled or failed upload](#restarting-a-cancelled-or-failed-upload)
  - [Drag and drop does not work for uploads](#drag-and-drop-does-not-work-for-uploads)
- [Exploring data](#exploring-data)
  - [Cannot access a draft dataset](#cannot-access-a-draft-dataset)
  - [Need to explore a previous dataset version](#need-to-explore-a-previous-dataset-version)
  - [Quickly reopen frequently accessed datasets](#quickly-reopen-frequently-accessed-datasets)
  - [User doesn't know that datasets are paginated](#user-doesnt-know-that-datasets-are-paginated)
  - [Update or delete a saved repository API key](#update-or-delete-a-saved-repository-api-key)
  - [DOI or dataset URL does not work in the Explore bar](#doi-or-dataset-url-does-not-work-in-the-explore-bar)
  - [Repository compatibility issues](#repository-compatibility-issues)
- [Others](#others)
  - [Automatic sync is not available](#automatic-sync-is-not-available)  
  - [Transfers never start processing](#transfers-stuck-in-pending-state)
  - [How to start the detached process](#how-to-start-the-detached-process)
  - [Where are the log files located?](#where-are-the-log-files-located)

## Projects

### Project was deleted accidentally
- **Symptoms**: A user removes a project and worries that associated files are lost. They want to recover downloads or upload files.
- **Resolution**: Deleting a project only removes its metadata from Loop in `~/.loop_metadata/projects/<project_id>` folder. downloaded files remain on disk in the project folder and uploads stay in the remote repository.
- **Escalation**: Project metadata recovery is possible from a backup if exists. Nonetheless, the metadata inside a project is not significant enough for the work required to do the restore. It is recommended to create a new project again.

### Rename a project
- **Symptoms**: A user wants to change the autogenerated project name and is unsure where the rename control lives.
- **Resolution**: Click the pencil icon next to the project title on the project detail page to rename it instantly.

### Update the project workspace to a shared folder
- **Symptoms**: The user wants new downloads to land inside a shared folder instead of their default `~/loop_downloads` project workspace.
- **Resolution**: Open the project detail page and press the pencil button in the **Download Files** tab header to choose a different workspace folder. Use the file browser to navigate into the target directory and select it; Loop immediately updates the project to use that path for all future downloads. Existing downloaded files are moved from the original location to the new folder automatically.
- **Escalation**: If the shared folder cannot be selected, ensure the user has write permissions.

### Changing the project folder fails
- **Symptoms**: A user tries to update the project folder in Loop, but the change fails. Error messages mention permissions or files in progress.
- **Resolution**: Project folder cannot be updated if there are download files pending or in progress: Wait until all files are transferred. If there are no ongoing files, ensure that the user has write permissions on the target folder and that the folder exists.
- **Escalation**: If filesystem permissions look correct, check quotas and directory ACLs on that disk partition.

### Beta regression requiring a factory reset
- **Symptoms**: After upgrading Loop, a user reports that previously working projects show errors or stacktraces, or new downloads/uploads never start. Only some accounts are affected, typically ones that already had Loop metadata from a prior beta build.
- **Resolution**: Use **Help → Reset Application** in the Loop navigation menu to wipe the metadata folder for the user. This action is safe but cannot be undone. If the reset dialog is unavailable or the problem persists, instruct the user to manually remove their metadata directory `~/.loop_metadata`. The Projects section on the User Guide describes the purpose of these folders so users understand what will be cleared. Have the user recreate their projects and re-download the files if necessary.

### Beta regression requiring a factory reset
- **Symptoms**: After upgrading Loop, a user reports that previously working projects show errors or stacktraces, or new downloads/uploads never start. Only some accounts are affected, typically ones that already had Loop metadata from a prior beta build.
- **Resolution**: Use **Help → Reset Application** in the Loop navigation menu to wipe the metadata folder for the user. This action is safe but cannot be undone.
  - The **Reset** action is only enabled if there are no active or pending downloads/uploads. Any such files must either be allowed to complete or be manually deleted before a reset can be performed.
  - If the reset dialog is unavailable or the problem persists, instruct the user to manually remove their metadata directory `~/.loop_metadata`.
  - The *Projects* section in the User Guide describes the purpose of these folders so users understand what will be cleared.
  - After resetting, the user will need to recreate their projects and re-download files if necessary.

## Downloads

### Files are greyed out and cannot be downloaded
- **Symptoms**: Individual files in a dataset explore view appear disabled or grey, and the download button is unavailable. 
- **Resolution**: This indicates that the files are restricted or under embargo in the remote repository. Or it can also be that its size is higher than `max_download_file_size` which is 10 GB by default. There is additional information about the cause by hovering the mouse over the icon in the greyed out file.
- **Escalation**: `max_download_file_size` can be updated by following the Admin Guide to suport larger files if required. For restricted or embargoed files, collect the file identifier, repository version, and any API responses if the file should be public but remains disabled.

### Where are my downloaded files?
- **Symptoms**: A user triggered a download but cannot locate the data on disk. They expect Loop to provide a link to open the correct directory for them.
- **Resolution**: Download files are organized by project. Identify the project, open its detail page and switch to the **Downloads** tab. The header shows the folder icon that opens the project workspace in the Open OnDemand Files app, pointing to the exact filesystem location for that project's downloads. By default, Loop stores project workspaces under the configured `download_root` application property that defaults to `~/loop_downloads`, so the files will appear in that directory hierarchy.

### How can I copy or move my downloaded files into my shared folder?
- **Symptoms**: After downloading data, the user wants to copy/move the files into a shared directory but does not see a copy/move option inside Loop.
- **Resolution**: If the user wants to use the shared folder as the project workspace, use the pencil button on the **Downloads** tab on the project detail view to change the project folder. All files downloaded onto that project will be moved automatically from the previous folder into the new one. 

  If the user wants to copy/move files to the shared folder but continue working on the same Loop workspace, use the Open OnDemand Files application. To open the Files application use the folder button in the **Downloads** tab in the project detail view. Select the files you want to copy, click on Copy/Move, go to the target location and click on the Copy/Move button.
- **Escalation**: If the user cannot reach the target shared directory, confirm the user’s filesystem permissions or disk quotas.

### Download is stuck in the Downloading state
- **Symptoms**: A download file shows `Downloading` indefinitely in the **Downloads** page, even after refreshing it. The system continues to download other files, but the affected file never changes the status. 
- **Resolution**: This could happen if the detached process aborts or the server is shutdown while a file is being downloaded. The file keeps the `downloading` status. On the next detached process start-up, it will only process files in `pending` state. Any other state is ignored, including `downloading`. This scenario is logged in the DownloadService.

  To fix the issue ask the user to cancel the download file using the cancel button in the **Downloads** page and use the retry functionality. 
- **Escalation**: If this problem becomes a common occurrance, further investigation will be required to understand why the detached process is failing so often. 

### Download shows an error status
- **Symptoms**: A download displays an `error` badge. The user is unsure what to do next.
- **Resolution**: As a first step, tell the user to retry the download. 

    Possible reasons for this error are network connectivity issues, MD5 checksum verification failures, authentication errors on private data downloads or disk space. If the problem persists after retries, check the file event logs in the application to get further information
- **Escalation**: If the problem relates to disk space, ask the user to change the project workspace location. 
If the problem relates to authentication, ask the user to provide the appropriate API key for the related repository. This might solve the issue.

### New downloads fail because storage is full
- **Symptoms**: Selecting files for download immediately display errors with filesystem quota or disk space messages.
- **Resolution**: The application requires to write metadata on the user's home directory. If this directory become full, the application will not be able to schedule new files to download. Ask the user to free disk space on their home directory by deleting unneeded files.

### What happens if I download the same file twice?
- **Symptoms**: Users worry that downloading a file again will overwrite the version already on disk.
- **Resolution**: Loop automatically renames duplicate downloads by appending a numeric suffix (for example, `_01`, `_02`) so each transfer lands alongside the earlier version without overwriting it.

### Restarting a cancelled or failed download
- **Symptoms**: A user cancels a download, or it fails with an error, and they expect an automatic retry that it is not happening.
- **Resolution**: Loop does not automatically retry failed downloads. User needs to click on the **Retry** button on the file row. Alternatively, users can create a new download for the same file to repeat the process. Review the event logs on the file to understand the failure reason.


## Uploads

### Upload shows an error status
- **Symptoms**: A upload displays an `error` badge. The user is unsure what to do next.
- **Resolution**: As a first step, tell the user to retry the upload. 

  Possible reasons for this error are network connectivity issues, MD5 checksum verification failures or authentication errors. If the problem persists after retries, check the file event logs in the application to get further information
- **Escalation**: If the problem relates to authentication, ask the user to provide the appropriate API key for the related repository in the **Repository Settings**. This might solve the issue.

### Uploading large files is blocked
- **Symptoms**: Attempting to select a file to upload above a certain size immediately fails. Error messages mention exceeding the configured limit.
- **Resolution**: Loop enforces `max_upload_file_size` for uploads which is 1 GB by default. Suggest splitting the data into smaller archives if possible.
- **Escalation**: `max_upload_file_size` can be updated by following the Admin Guide to suport larger files if required.

### How do I navigate to the remote repository where my files are uploaded?
- **Symptoms**: After uploading files to a dataset, the user wants to verify them on the remote repository but cannot find a direct link from Loop.
- **Resolution**: Open the upload bundle tab used to upload the file on the project detail view. In the repository actions bar identified by the plug icon, there you will see the description of the remote dataset where the files have been uploaded. This description links back to the remote dataset. 

### Restarting a cancelled or failed upload
- **Symptoms**: A user cancels a upload, or it fails with an error, and they expect an automatic retry that it is not happening.
- **Resolution**: Loop does not automatically retry failed uploads. User needs to click on the **Retry** button on the file row. Alternatively, users can create a new upload for the same file to repeat the process. Review the event logs on the file to understand the failure reason.

### Drag and drop does not work for uploads
- **Symptoms**: Dragging files from the file browser into the upload drop zone doesn't work.
- **Resolution**: There might be a Javascript issue or a browser incompatibility for the drag&drop feature. Advise the user to double-click files in the file browser to select them or rely on keyboard navigation, both of which are fully supported alternatives.
- **Escalation**: Request the information about the browser and create an issue at `https://github.com/IQSS/ondemand-loop/issues`.

## Exploring data

### Cannot access a draft dataset
- **Symptoms**: A user reports that exploring a draft dataset shows an authorization error message.
- **Resolution**: Confirm that the dataset version is `draft`. Draft versions require API keys even if the published dataset is public. Ask the user to open **Repositories → Settings** and add a valid API key for the affected repository. API keys saved there automatically apply to browsing and downloads.
- **Escalation**: If an API key is present but the error message still shows, ensure that API key has permissions to explore that dataset. 

### Need to explore a previous dataset version
- **Symptoms**: A user wants to review an earlier version of a dataset but they don't know how.
- **Resolution**: OnDemand Loop supports exploring multiple versions on a dataset. Load the dataset via the **Explore** workflow. Use the dataset version selector, the plus button on the right hand side of the dataset description section, to select another version. Please note that due to API restrictions, only the last 10 versions are displayed. 

### Quickly reopen frequently accessed datasets
- **Symptoms**: The user repeatedly searches for the same dataset even though they recently explored it in Loop. They are unaware of a shortcut to reopen the dataset directly.
- **Resolution**: Point them to the folder icon next in the the Explore bar next to the **Explore** button. Clicking it opens the **Repository Activity** dialog, which lists recently browsed datasets. From the list you can explore the datasets or open the remote repository website.

### User doesn't know that datasets are paginated
- **Symptoms**: Only the first batch of files is displayed when viewing datasets. Pagination controls show that more files exist, but the user is unaware of them.
- **Resolution**: Explain that Loop paginates file listings based on the configured default page size (20 items by default). Use the pagination controls in the dataset explorer to load additional pages of files. 
- **Escalation**: For installations that regularly handle very large datasets, administrators can raise `default_pagination_items` so more files appear per page.

### Update or delete a saved repository API key
- **Symptoms**: A user needs to rotate credentials or remove repository access after leaving a project but cannot find where saved API keys live.
- **Resolution**: API keys are stored globally in repository settings and locally in Upload Bundles. 
Open **Repositories → Settings** to view every repository Loop has stored. From this page you can edit the existing API key value or delete the entire repository entry, which clears the stored credentials and any connector-specific settings. Updating the key takes effect immediately — no restart is required. 
Review related Upload Bundles to update the required locally-stored API keys.
- **Escalation**: Globally-stored API keys are stored in `~/.loop_metadata/repos/repo_db.yml` file. Upload Bundle's API keys are stored inside the upload bundle metadata file which is stored in `~/.loop_metadata/projects/<project-id>/upload_bundles/<upload-bundle-id>/metadata.yml`.

### DOI or dataset URL does not work in the Explore bar
- **Symptoms**: Pasting a DOI or dataset URL results in an error message. The user may be unsure which formats are accepted.
- **Resolution**: Confirm the identifier matches a supported format:
  - `doi:10.7910/DVN/MYSRMN`, 
  - `10.5281/zenodo.4884775`, 
  - `https://doi.org/10.7910/DVN/MYSRMN`, 
  - `https://doi.org/10.5281/zenodo.4884775`, 
  - `https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi%3A10.7910%2FDVN%2FMYSRMN&version=1.0`. 
  
  Ensure that this DOI links to a dataset in one of the supported repositories. You can use the `https://www.doi.org` website to resolve the DOI. 
- **Escalation**: If DOI is linked to a supported repository and fails, create an OnDemand Loop issue at `https://github.com/IQSS/ondemand-loop/issues`.

### Repository compatibility issues
- **Symptoms**: Users reports missing data, missing pagination and errors when browsing a Dataverse collection or dataset. 
- **Resolution**: Loop uses the Dataverse API to get collection and dataset information. The application has been developed using recent versions of Dataverse, 6.x series. Support for previous versions is limited or non-existant. See `https://iqss.github.io/ondemand-loop/user_guide/supported_repositories/`.
For Dataverse versions with limited support, this behaviour is expected. To validate the version use the url `https://<server_hostname>/api/info/version` endpoint.
- **Escalation**: If you want to support this Dataverse version, create an issue at `https://github.com/IQSS/ondemand-loop/issues`.

## Others

### Automatic sync is not available
- **Symptoms**: The user asks how to keep a project in sync with a remote repository automatically, or they report that new revisions never appear locally unless they take manual action.
- **Resolution**: Explain that OnDemand Loop performs discrete transfers only. Each upload or download must be triggered manually. Downloads and uploads must be re-queued whenever content changes; there is no background synchronization process. 

### Transfers stuck in pending state
- **Symptoms**: Download or Upload files stay in `pending` state and the progress bar never appears.
- **Resolution**: This is likely that the detached process is failing to run. The detached proccess is executed automatically by the front-end using AJAX requests. To trigger the detached process again load any page of the application.
- **Escalation**: If the problem persists, look at the detached proccess log file and investigate the cause of the error. 

### How to start the detached process
- **Symptoms**: Support staff wants to start the detached process to start transferring the files.
- **Resolution**: The detached proccess is executed automatically by the front-end using AJAX requests. To trigger the detached process again load any page of the application. Using the browser web console on the network traffic there will be requests to the detached process status controller `https://<server_hostname>/pun/sys/loop/detached_process/status`. Every time this request is processed the detached process is executed.

### Where are the log files located?
- **Symptoms**: Support staff need to inspect Loop logs but are unsure where the application writes them for a given user.
- **Resolution**: Each user has a metadata directory (configured via `metadata_root` property, `~/.loop_metadata` by default) that holds Loop’s internal state as well as log outputs of the detached procees: `launch_detached_process.log`. The main Rails logging file is located under `/var/log/ondemand-nginx/<user>/error.log`.